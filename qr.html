<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é›²ç«¯ç™¼ç¥¨æƒæå™¨</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
    }

    .video-container {
      position: relative;
      width: 100%;
      aspect-ratio: 3/4;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .scanner-corners {
      position: absolute;
      width: 60%;
      aspect-ratio: 1/1;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 12;
    }

    .corner {
      position: absolute;
      width: 45px;
      height: 45px;
      border: 10px solid #abb3b6;
      border-radius: 1px;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }

    .corner.success {
      border-color: #28a745 !important;
    }

    .corner.tl {
      top: 0;
      left: 0;
      border-right: none;
      border-bottom: none;
    }

    .corner.tr {
      top: 0;
      right: 0;
      border-left: none;
      border-bottom: none;
    }

    .corner.bl {
      bottom: 0;
      left: 0;
      border-right: none;
      border-top: none;
    }

    .corner.br {
      bottom: 0;
      right: 0;
      border-left: none;
      border-top: none;
    }

    .scanner-mask {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9;
      pointer-events: none;
    }

    .scanner-mask::before {
      content: "";
      position: absolute;
      width: 60%;
      aspect-ratio: 1 / 1;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0);
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }

    .scanner-instruction {
      position: absolute;
      top: 12%;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 1rem;
      font-weight: bold;
      text-shadow: 0 0 5px black;
      z-index: 15;
    }

    .scan-success-message {
      position: absolute;
      top: 42%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 16;
      font-size: 2rem;
      color: #28a745;
      font-weight: bold;
      text-shadow: 0 0 6px black;
      display: none;
    }

    #canvas {
      display: none;
    }
  </style>
</head>
<body class="p-4">
  <h1 class="mb-4">é›²ç«¯ç™¼ç¥¨ QR Code æƒæ</h1>
  <div class="mb-4">
    <p><strong>æœ€è¿‘æƒæï¼š</strong></p>
    <p>ç™¼ç¥¨è™Ÿç¢¼ï¼š<span id="last-invoice-number">-</span></p>
    <p>ç™¼ç¥¨æ—¥æœŸï¼š<span id="last-invoice-date">-</span></p>
    <p>éš¨æ©Ÿç¢¼ï¼š<span id="last-random-code">-</span></p>
    <p>ç¸½é‡‘é¡ (å«ç¨…)ï¼š<span id="total-amount">-</span> å…ƒ</p>
    <p>è³£æ–¹çµ±ç·¨ï¼š<span id="seller_id">-</span></p>
    <p>è²·æ–¹çµ±ç·¨ï¼š<span id="buyer_id">-</span></p>
  </div>

  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scanModal">é–‹å§‹æƒæ</button>

  <div class="modal fade" id="scanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header border-0">
          <h5 class="modal-title">é›»å­ç™¼ç¥¨æƒæ</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0 position-relative">
          <div class="video-container">
            <video id="video" playsinline></video>
            <canvas id="canvas"></canvas>
            <div class="scanner-mask"></div>
            <div class="scanner-corners">
              <div class="corner tl"></div>
              <div class="corner tr"></div>
              <div class="corner bl"></div>
              <div class="corner br"></div>
              <div class="scan-success-message">ğŸ‰ æƒææˆåŠŸ</div>
            </div>
            <div class="scanner-instruction">
              è«‹æƒæé›»å­ç™¼ç¥¨å·¦å´çš„ QR Code<br /><small>(ä½¿ç”¨é ˆçŸ¥èˆ‡æ›´å¤šèªªæ˜)</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $video = $('#video');
    const $canvas_element = $('#canvas');
    const canvas = $canvas_element[0].getContext("2d");

    const $last_invoice_number = $('#last-invoice-number');
    const $last_invoice_date = $('#last-invoice-date');
    const $last_random_code = $('#last-random-code');
    const $total_amount = $('#total-amount');
    const $seller_id = $('#seller_id');
    const $buyer_id = $('#buyer_id');
    const $scan_message = $('.scan-success-message');
    const $corners = $('.corner');

    let stream = null;
    let scanning = false;
    let current_track = null;
    let capabilities = null;

    async function start_scan() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: "environment",
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });

        $video[0].srcObject = stream;
        await $video[0].play();

        current_track = stream.getVideoTracks()[0];
        capabilities = current_track.getCapabilities?.();

        if (capabilities?.zoom) {
          await current_track.applyConstraints({
            advanced: [{ zoom: Math.min(2.75, capabilities.zoom.max || 2.75) }]
          });
        }

        scanning = true;
        requestAnimationFrame(tick);
      } catch (err) {
        alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: " + err.message);
      }
    }

    function stop_scan() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        $video[0].srcObject = null;
        stream = null;
      }
      scanning = false;
      $corners.removeClass('success');
      $scan_message.hide();
    }

    function tick() {
      if (!scanning || $video[0].readyState !== $video[0].HAVE_ENOUGH_DATA) return;

      $canvas_element.prop("width", $video[0].videoWidth);
      $canvas_element.prop("height", $video[0].videoHeight);
      canvas.drawImage($video[0], 0, 0, $canvas_element[0].width, $canvas_element[0].height);

      const crop_x = $canvas_element[0].width * 0.2;
      const crop_y = $canvas_element[0].height * 0.2;
      const crop_width = $canvas_element[0].width * 0.6;
      const crop_height = $canvas_element[0].height * 0.6;
      const cropped = canvas.getImageData(crop_x, crop_y, crop_width, crop_height);

      const code = jsQR(cropped.data, crop_width, crop_height, {
        inversionAttempts: "dontInvert"
      });

      if (code?.data?.length >= 77) {
        try {
          const d = code.data;
          const num = d.substring(0, 10);
          const date_str = d.substring(10, 17);
          const rand = d.substring(17, 21);
          const amount_hex = d.substring(29, 37);
          const buyer = d.substring(37, 45);
          const seller = d.substring(45, 53);
          const amount = parseInt(amount_hex, 16);
          const date = `${parseInt(date_str.substring(0, 3), 10) + 1911}-${date_str.substring(3, 5)}-${date_str.substring(5, 7)}`;

          if (/^[A-Z]{2}\d{8}$/.test(num)) {
            // æ›´æ–°ä¸»é é¡¯ç¤ºè³‡æ–™
            $last_invoice_number.text(num);
            $last_invoice_date.text(date);
            $last_random_code.text(rand);
            $total_amount.text(amount);
            $buyer_id.text(buyer);
            $seller_id.text(seller);

            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯èˆ‡ç‰¹æ•ˆ
            if (navigator.vibrate) navigator.vibrate(300);
            $corners.addClass('success');
            $scan_message.fadeIn();
            scanning = false;

            setTimeout(() => {
              $scan_message.fadeOut();
              const modal = bootstrap.Modal.getInstance($('#scanModal')[0]);
              modal.hide();
            }, 1500);
            return;
          }
        } catch (e) {
          console.error(e);
        }
      }

      if (scanning) requestAnimationFrame(tick);
    }

    $('#scanModal').on('shown.bs.modal', () => start_scan());
    $('#scanModal').on('hidden.bs.modal', () => stop_scan());
  </script>
</body>
</html>
