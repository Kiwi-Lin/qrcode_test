<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>雲端發票 QR Code 掃描解析</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 30px; }
    #result { margin-top: 20px; padding: 15px; border: 1px solid #ccc; width: 90%; max-width: 500px; margin-left: auto; margin-right: auto; }
  </style>
</head>
<body>

  <h2>雲端發票 QRCode 掃描與解析</h2>
  <div id="reader" style="width: 300px; margin: auto;"></div>
  <div id="result"></div>

  <script>
    function parseTaiwanEInvoice(rawData) {
      try {
        const raw = atob(rawData); // base64 解碼

        const number = raw.substring(0, 10);
        const date = raw.substring(10, 17);
        const year = 1911 + parseInt(date.substring(0, 3));
        const month = date.substring(3, 5);
        const day = date.substring(5, 7);
        const randomCode = raw.substring(17, 21);
        const salesAmount = parseInt(raw.substring(21, 29), 16);
        const totalAmount = parseInt(raw.substring(29, 37), 16);
        const buyerId = raw.substring(37, 45).replace(/\0/g, '');
        const sellerId = raw.substring(45, 53).replace(/\0/g, '');

        return {
          發票號碼: number,
          發票日期: `${year}-${month}-${day}`,
          隨機碼: randomCode,
          銷售額: salesAmount,
          總金額: totalAmount,
          買方統編: buyerId,
          賣方統編: sellerId,
        };
      } catch (err) {
        return { 錯誤: '解析失敗，可能不是正確的發票 QRCode' };
      }
    }

    function onScanSuccess(decodedText, decodedResult) {
      console.log("掃描結果:", decodedText);
      const parsed = parseTaiwanEInvoice(decodedText);

      let html = "<h3>發票資訊</h3><ul>";
      for (const [key, val] of Object.entries(parsed)) {
        html += `<li><strong>${key}：</strong>${val}</li>`;
      }
      html += "</ul>";

      document.getElementById("result").innerHTML = html;
    }

    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" }, // 後鏡頭
      {
        fps: 10,
        qrbox: 250
      },
      onScanSuccess
    ).catch(err => {
      document.getElementById("result").innerText = "無法啟動攝影機：" + err;
    });
  </script>

</body>
</html>
