<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é›²ç«¯ç™¼ç¥¨ QRCode é›™é‚Šæƒæå™¨</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 30px; }
    #reader { width: 300px; margin: auto; }
    #result { margin-top: 20px; padding: 15px; border: 1px solid #ccc; width: 90%; max-width: 500px; margin-left: auto; margin-right: auto; }
    textarea { width: 100%; font-family: monospace; font-size: 14px; }
    #tip { color: #666; font-size: 14px; margin-top: 10px; }
  </style>
</head>
<body>

  <h2>é›²ç«¯ç™¼ç¥¨ QRCode é›™é‚Šæƒæå™¨</h2>
  <p id="tip">è«‹å°‡ç™¼ç¥¨å…©é‚Š QR Code ä¾åºæƒæï¼ˆé †åºä¸æ‹˜ï¼‰</p>
  <div id="reader"></div>
  <div id="result">å°šæœªæƒæä»»ä½•å…§å®¹</div>

  <script>
    let qrLeft = null;
    let qrRight = null;
    let lastScanTime = 0;

    function parseLeftQRCode(data) {
      try {
        const raw = atob(data);
        if (raw.length < 77) return { éŒ¯èª¤: 'è³‡æ–™é•·åº¦ä¸è¶³ï¼Œéæ¨™æº–æ ¼å¼' };

        const number = raw.substring(0, 10);
        const date = raw.substring(10, 17);
        const year = 1911 + parseInt(date.substring(0, 3));
        const month = date.substring(3, 5);
        const day = date.substring(5, 7);
        const randomCode = raw.substring(17, 21);
        const salesAmount = parseInt(raw.substring(21, 29), 16);
        const totalAmount = parseInt(raw.substring(29, 37), 16);
        const buyerId = raw.substring(37, 45).replace(/\0/g, '');
        const sellerId = raw.substring(45, 53).replace(/\0/g, '');
        const detailCount = raw.charCodeAt(77);

        return {
          ç™¼ç¥¨è™Ÿç¢¼: number,
          ç™¼ç¥¨æ—¥æœŸ: `${year}-${month}-${day}`,
          éš¨æ©Ÿç¢¼: randomCode,
          éŠ·å”®é¡: salesAmount,
          ç¸½é‡‘é¡: totalAmount,
          è²·æ–¹çµ±ç·¨: buyerId,
          è³£æ–¹çµ±ç·¨: sellerId,
          å•†å“ç­†æ•¸: detailCount
        };
      } catch (e) {
        return { éŒ¯èª¤: 'Base64 è§£ç¢¼å¤±æ•—ï¼Œéå·¦é‚Š QRCode' };
      }
    }

    function parseRightQRCode(data) {
      const parts = data.split(":");
      return {
        base64æ®µ: parts[0],
        æ†‘è­‰ç¢¼: parts[1],
        å•†å“ç­†æ•¸: parts[2],
        åç¨±é•·åº¦: parts[3],
        å€æ®µæ•¸é‡: parts[4],
        è£œç¢¼: parts[5]
      };
    }

    function displayCombinedResult() {
      let html = `<h3>ğŸ“„ ç™¼ç¥¨è³‡è¨Š</h3><ul>`;
      const parsedLeft = parseLeftQRCode(qrLeft);
      for (const [k, v] of Object.entries(parsedLeft)) {
        html += `<li><strong>${k}</strong>ï¼š${v}</li>`;
      }
      html += `</ul>`;

      const parsedRight = parseRightQRCode(qrRight);
      html += `<h3>ğŸ§¾ å•†å“å€æ®µï¼ˆå³ QRCodeï¼‰</h3><ul>`;
      for (const [k, v] of Object.entries(parsedRight)) {
        html += `<li><strong>${k}</strong>ï¼š${v}</li>`;
      }
      html += "</ul>";

      document.getElementById("result").innerHTML = html;

      // é‡ç½®
      qrLeft = null;
      qrRight = null;
    }

    function onScanSuccess(decodedText) {
      const now = Date.now();
      if (now - lastScanTime < 1000) return; // é¿å…é€£çºŒè§¸ç™¼
      lastScanTime = now;

      if (decodedText.includes(":")) {
        qrRight = decodedText;
        console.log("âœ… åµæ¸¬åˆ°å³ QRCode");
      } else {
        qrLeft = decodedText;
        console.log("âœ… åµæ¸¬åˆ°å·¦ QRCode");
      }

      if (qrLeft && qrRight) {
        displayCombinedResult();
      }
    }

    async function startScanner() {
      const html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess
      );
    }

    startScanner();
  </script>

</body>
</html>
