<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>雲端發票 QRCode 雙邊掃描器</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 30px; }
    #reader { width: 300px; margin: auto; }
    #result { margin-top: 20px; padding: 15px; border: 1px solid #ccc; width: 90%; max-width: 500px; margin-left: auto; margin-right: auto; }
    textarea { width: 100%; font-family: monospace; font-size: 14px; }
    #tip { color: #666; font-size: 14px; margin-top: 10px; }
  </style>
</head>
<body>

  <h2>雲端發票 QRCode 雙邊掃描器</h2>
  <p id="tip">請將發票兩邊 QR Code 依序掃描（順序不拘）</p>
  <div id="reader"></div>
  <div id="result">尚未掃描任何內容</div>

  <script>
    let qrLeft = null;
    let qrRight = null;
    let lastScanTime = 0;

    function parseLeftQRCode(data) {
      try {
        const raw = atob(data);
        if (raw.length < 77) return { 錯誤: '資料長度不足，非標準格式' };

        const number = raw.substring(0, 10);
        const date = raw.substring(10, 17);
        const year = 1911 + parseInt(date.substring(0, 3));
        const month = date.substring(3, 5);
        const day = date.substring(5, 7);
        const randomCode = raw.substring(17, 21);
        const salesAmount = parseInt(raw.substring(21, 29), 16);
        const totalAmount = parseInt(raw.substring(29, 37), 16);
        const buyerId = raw.substring(37, 45).replace(/\0/g, '');
        const sellerId = raw.substring(45, 53).replace(/\0/g, '');
        const detailCount = raw.charCodeAt(77);

        return {
          發票號碼: number,
          發票日期: `${year}-${month}-${day}`,
          隨機碼: randomCode,
          銷售額: salesAmount,
          總金額: totalAmount,
          買方統編: buyerId,
          賣方統編: sellerId,
          商品筆數: detailCount
        };
      } catch (e) {
        return { 錯誤: 'Base64 解碼失敗，非左邊 QRCode' };
      }
    }

    function parseRightQRCode(data) {
      const parts = data.split(":");
      return {
        base64段: parts[0],
        憑證碼: parts[1],
        商品筆數: parts[2],
        名稱長度: parts[3],
        區段數量: parts[4],
        補碼: parts[5]
      };
    }

    function displayCombinedResult() {
      let html = `<h3>📄 發票資訊</h3><ul>`;
      const parsedLeft = parseLeftQRCode(qrLeft);
      for (const [k, v] of Object.entries(parsedLeft)) {
        html += `<li><strong>${k}</strong>：${v}</li>`;
      }
      html += `</ul>`;

      const parsedRight = parseRightQRCode(qrRight);
      html += `<h3>🧾 商品區段（右 QRCode）</h3><ul>`;
      for (const [k, v] of Object.entries(parsedRight)) {
        html += `<li><strong>${k}</strong>：${v}</li>`;
      }
      html += "</ul>";

      document.getElementById("result").innerHTML = html;

      // 重置
      qrLeft = null;
      qrRight = null;
    }

    function onScanSuccess(decodedText) {
      const now = Date.now();
      if (now - lastScanTime < 1000) return; // 避免連續觸發
      lastScanTime = now;

      if (decodedText.includes(":")) {
        qrRight = decodedText;
        console.log("✅ 偵測到右 QRCode");
      } else {
        qrLeft = decodedText;
        console.log("✅ 偵測到左 QRCode");
      }

      if (qrLeft && qrRight) {
        displayCombinedResult();
      }
    }

    async function startScanner() {
      const html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess
      );
    }

    startScanner();
  </script>

</body>
</html>
