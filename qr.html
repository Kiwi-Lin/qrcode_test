<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>雲端發票 QRCode 掃描器</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 30px; }
    #reader { width: 300px; margin: auto; }
    #result { margin-top: 20px; padding: 15px; border: 1px solid #ccc; width: 90%; max-width: 500px; margin-left: auto; margin-right: auto; }
    textarea { width: 100%; font-family: monospace; font-size: 14px; }
    #tip { color: #666; font-size: 14px; margin-top: 10px; }
  </style>
</head>
<body>

  <h2>雲端發票 QRCode 掃描器</h2>
  <p id="tip">請將發票 QR Code 對準掃描框，保持約 10–15 公分距離，並避免反光</p>
  <div id="reader"></div>
  <div id="result">尚未掃描任何內容</div>

  <script>
    function parseTaiwanEInvoice(rawData) {
      try {
        const raw = atob(rawData);
        console.log("解碼後長度：", raw.length);

        if (raw.length < 77) {
          return { 錯誤: '資料長度不足，這可能是右邊 QRCode 或非標準格式' };
        }

        const number = raw.substring(0, 10);
        const date = raw.substring(10, 17);
        const year = 1911 + parseInt(date.substring(0, 3));
        const month = date.substring(3, 5);
        const day = date.substring(5, 7);
        const randomCode = raw.substring(17, 21);
        const salesAmount = parseInt(raw.substring(21, 29), 16);
        const totalAmount = parseInt(raw.substring(29, 37), 16);
        const buyerId = raw.substring(37, 45).replace(/\0/g, '');
        const sellerId = raw.substring(45, 53).replace(/\0/g, '');

        return {
          發票號碼: number,
          發票日期: `${year}-${month}-${day}`,
          隨機碼: randomCode,
          銷售額: salesAmount,
          總金額: totalAmount,
          買方統編: buyerId,
          賣方統編: sellerId,
        };
      } catch (err) {
        return { 錯誤: 'Base64 解碼失敗，這可能不是左邊 QRCode' };
      }
    }

    function onScanSuccess(decodedText, decodedResult) {
      console.log("掃描結果:", decodedText);
      const length = decodedText.length;
      let html = `<h3>原始 QRCode 資料</h3>
        <textarea rows="4" readonly>${decodedText}</textarea>`;

      if (length < 120) {
        // 推測為左邊 QRCode
        const parsed = parseTaiwanEInvoice(decodedText);
        html += "<h3>⚡ 偵測結果：左邊 QRCode（發票資訊）</h3><ul>";
        for (const [key, val] of Object.entries(parsed)) {
          html += `<li><strong>${key}：</strong>${val}</li>`;
        }
        html += "</ul>";
      } else {
        // 推測為右邊 QRCode
        html += "<h3>⚠️ 偵測結果：右邊 QRCode（明細資料）</h3>";
        html += "<p>右邊 QRCode 無法直接解析發票資訊，請改掃左邊。</p>";
      }

      document.getElementById("result").innerHTML = html;
    }

    async function startScanner() {
      try {
        const constraints = {
          video: {
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 },
            zoom: 2.0
          }
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        const videoTrack = stream.getVideoTracks()[0];
        const capabilities = videoTrack.getCapabilities();

        if (capabilities.zoom) {
          await videoTrack.applyConstraints({
            advanced: [{ zoom: capabilities.zoom.max || 2 }]
          });
          console.log("✅ Zoom 設定成功");
        } else {
          console.log("⚠️ 裝置不支援 Zoom 設定");
        }

        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
          { deviceId: { exact: videoTrack.getSettings().deviceId } },
          { fps: 10, qrbox: 250 },
          onScanSuccess
        );
      } catch (err) {
        console.error(err);
        document.getElementById("result").innerText = "⚠️ 無法啟動攝影機：" + err;
      }
    }

    startScanner();
  </script>

</body>
</html>
