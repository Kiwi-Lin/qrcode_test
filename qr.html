<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>雲端發票掃描器</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
    }

    .video-container {
      position: relative;
      width: 100%;
      aspect-ratio: 3/4;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .scanner-corners {
      position: absolute;
      width: 60%;
      aspect-ratio: 1/1;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 12;
    }

    .corner {
      position: absolute;
      width: 45px;
      height: 45px;
      border: 10px solid #abb3b6;
      border-radius: 1px;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }

    .corner.success {
      border-color: #28a745 !important;
    }

    .corner.tl { top: 0; left: 0; border-right: none; border-bottom: none; }
    .corner.tr { top: 0; right: 0; border-left: none; border-bottom: none; }
    .corner.bl { bottom: 0; left: 0; border-right: none; border-top: none; }
    .corner.br { bottom: 0; right: 0; border-left: none; border-top: none; }

    .scanner-mask {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9;
      pointer-events: none;
    }

    .scanner-mask::before {
      content: "";
      position: absolute;
      width: 60%;
      aspect-ratio: 1 / 1;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0);
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }

    .scanner-instruction {
      position: absolute;
      top: 12%;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 1rem;
      font-weight: bold;
      text-shadow: 0 0 5px black;
      z-index: 15;
    }

    .scan-success-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 16;
      padding: 2rem;
      background: rgba(40, 167, 69, 0.85);
      border-radius: 16px;
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
      text-align: center;
      animation: fadeIn 0.4s ease-out;
      display: none;
    }

    .checkmark {
      width: 72px;
      height: 72px;
      stroke: #fff;
      stroke-width: 4;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
      margin: 0 auto 0.5rem;
      animation: scaleIn 0.3s ease-out;
    }

    .checkmark-circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      animation: stroke 0.6s forwards;
    }

    .checkmark-check {
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.4s 0.4s forwards;
    }

    .success-text {
      font-size: 1.5rem;
      color: white;
      font-weight: 600;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -40%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    @keyframes stroke {
      to {
        stroke-dashoffset: 0;
      }
    }

    @keyframes scaleIn {
      0% {
        transform: scale(0.7);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    #canvas {
      display: none;
    }
  </style>
</head>
<body class="p-4">
  <h1 class="mb-4">雲端發票 QR Code 掃描</h1>
  <div class="mb-4">
    <p><strong>最近掃描：</strong></p>
    <p>發票號碼：<span id="last-invoice-number">-</span></p>
    <p>發票日期：<span id="last-invoice-date">-</span></p>
    <p>隨機碼：<span id="last-random-code">-</span></p>
    <p>總金額 (含稅)：<span id="total-amount">-</span> 元</p>
    <p>賣方統編：<span id="seller_id">-</span></p>
    <p>買方統編：<span id="buyer_id">-</span></p>
  </div>

  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scanModal">開始掃描</button>

  <div class="modal fade" id="scanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header border-0">
          <h5 class="modal-title">電子發票掃描</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0 position-relative">
          <div class="video-container">
            <video id="video" playsinline></video>
            <canvas id="canvas"></canvas>
            <div class="scanner-mask"></div>
            <div class="scanner-corners">
              <div class="corner tl"></div>
              <div class="corner tr"></div>
              <div class="corner bl"></div>
              <div class="corner br"></div>
              <div class="scan-success-message">
                <svg class="checkmark" viewBox="0 0 52 52">
                  <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" />
                  <path class="checkmark-check" fill="none" d="M14 27l7 7 17-17" />
                </svg>
                <div class="success-text">掃描成功</div>
              </div>
            </div>
            <div class="scanner-instruction">
              請掃描電子發票左側的 QR Code<br /><small>(使用須知與更多說明)</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $video = $('#video');
    const $canvas_element = $('#canvas');
    const canvas = $canvas_element[0].getContext("2d");

    const $last_invoice_number = $('#last-invoice-number');
    const $last_invoice_date = $('#last-invoice-date');
    const $last_random_code = $('#last-random-code');
    const $total_amount = $('#total-amount');
    const $seller_id = $('#seller_id');
    const $buyer_id = $('#buyer_id');
    const $scan_message = $('.scan-success-message');
    const $corners = $('.corner');

    let stream = null;
    let scanning = false;
    let current_track = null;
    let capabilities = null;

    async function start_scan() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: "environment",
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });

        $video[0].srcObject = stream;
        await $video[0].play();

        current_track = stream.getVideoTracks()[0];
        capabilities = current_track.getCapabilities?.();

        if (capabilities?.zoom) {
          await current_track.applyConstraints({
            advanced: [{ zoom: Math.min(2.75, capabilities.zoom.max || 2.75) }]
          });
        }

        scanning = true;
        requestAnimationFrame(tick);
      } catch (err) {
        alert("無法啟動相機: " + err.message);
      }
    }

    function stop_scan() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        $video[0].srcObject = null;
        stream = null;
      }
      scanning = false;
      $corners.removeClass('success');
      $scan_message.hide();
    }

    function tick() {
      if (!scanning || $video[0].readyState !== $video[0].HAVE_ENOUGH_DATA) return;

      $canvas_element.prop("width", $video[0].videoWidth);
      $canvas_element.prop("height", $video[0].videoHeight);
      canvas.drawImage($video[0], 0, 0, $canvas_element[0].width, $canvas_element[0].height);

      const crop_x = $canvas_element[0].width * 0.2;
      const crop_y = $canvas_element[0].height * 0.2;
      const crop_width = $canvas_element[0].width * 0.6;
      const crop_height = $canvas_element[0].height * 0.6;
      const cropped = canvas.getImageData(crop_x, crop_y, crop_width, crop_height);

      const code = jsQR(cropped.data, crop_width, crop_height, {
        inversionAttempts: "dontInvert"
      });

      if (code?.data?.length >= 77) {
        try {
          const d = code.data;
          const num = d.substring(0, 10);
          const date_str = d.substring(10, 17);
          const rand = d.substring(17, 21);
          const amount_hex = d.substring(29, 37);
          const buyer = d.substring(37, 45);
          const seller = d.substring(45, 53);
          const amount = parseInt(amount_hex, 16);
          const date = `${parseInt(date_str.substring(0, 3), 10) + 1911}-${date_str.substring(3, 5)}-${date_str.substring(5, 7)}`;

          if (/^[A-Z]{2}\d{8}$/.test(num)) {
            $last_invoice_number.text(num);
            $last_invoice_date.text(date);
            $last_random_code.text(rand);
            $total_amount.text(amount);
            $buyer_id.text(buyer);
            $seller_id.text(seller);

            if (navigator.vibrate) navigator.vibrate(300);
            $corners.addClass('success');
            $scan_message.fadeIn();
            scanning = false;

            setTimeout(() => {
              $scan_message.fadeOut();
              const modal = bootstrap.Modal.getInstance($('#scanModal')[0]);
              modal.hide();
            }, 1500);
            return;
          }
        } catch (e) {
          console.error(e);
        }
      }

      if (scanning) requestAnimationFrame(tick);
    }

    $('#scanModal').on('shown.bs.modal', () => start_scan());
    $('#scanModal').on('hidden.bs.modal', () => stop_scan());
  </script>
</body>
</html>
